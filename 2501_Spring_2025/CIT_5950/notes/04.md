[Back to Main](../main.md)

# OS Start: Processes & Fork

### Concept) Operating System (OS)
![](../images/04/001.png)
- Desc.)
  - OS is a SW that...
    - directly interacts with the HW
    - abstracts away messy HW devices
    - manages HW resources
      - e.g.) allocating, scheduling, and protecting
        ![](../images/04/002.png)

<br>

#### Concept) System Call
- Desc.)
  - The way that user program call OS
- Procedure)
  1. CPU runs a user-level code in a [process]().
     - CPU is set to unprivileged mode
  2. Code in process invokes a **system call**.
     - HW sets the CPU to privileged mode
     - Traps into the OS
     - Invokes the appropriate system call handler
       - e.g.) `glibc` for Linux
  3. CPU runs privileged instructions that interact directly with the HW devices.
  4. When servicing the system call is finished by the OS
     1. OS sets CPU back to unprivileged mode
     2. Returns out the system call back to the user-level code in the original process.
  5. (if applicable) CPU runs remaining codes in the process.

<br>

### Concept) Process
- Def.)
  - An instance of a program that is being executed (or is being for execution)
- Prop.)
  - Consists of:
    - memory
    - registers
    - other resources
  - Multiple processes
    - Computers run multiple processes at the same time.
    - OS isolates precess from each other
      - Each process seem to exclusively use its own memory and processor.
        - Illusion
    - OS also permits controlled sharing resources between processes.
      |Single Core|Multi Core|
      |:-:|:-:|
      |![](../images/04/004.png)|![](../images/04/005.png)|  
- Tech.)
  - In cpp, a process can be 
    - created using the [`fork()`](#os-start-processes--fork) function.
    - exited using `exit()`
      - Desc.)
        - Causes the current process to exit normally
        - Automatically called by `main()` when it returns.
        - Return statuses `#include <cstdlib>`
          - `EXIT_SUCCESS`
          - `EXIT_FAILURE`
            - These statuses are accessible by the parent process with `wait()` or `waitpid()`

<br>

### Concept) Creating new processes with fork
- Desc.)
  - A function that creates a new process that is an exact clone of the current process
    - Parent : the current process
    - Child : the newly created process from Parent
  - The new process has a separate virtual address space from the parent
  - It returns `pid_t` (the process id of the child) in an integer type.
    - For the parent who called `fork()`, the pid of the child is returned.
    - For the child who is created by the `fork()` call, it returns `0`.
  - The copies of the memory segments are nearly identical.
    - Even the global variable is cloned independently.
- Example)
  ```cpp
  #include <iostream>
  #include <unistd.h>
  #include <cstdlib>
  
  using namespace std;
  
  // Test 1
  int pid_difference_test(){
          pid_t p = fork();
  
          if (p == 0) {
                  cout << "Child" << endl;
          } else {
                  cout << "Parent" << endl;
          }
  
          return EXIT_SUCCESS;
  }
  
  
  
  // Test 2
  int variable_exclusion_test(){
          int x = 3;
          fork();
          x++;
          cout << x << endl;
  
          return EXIT_SUCCESS;
  }
  
  
  
  // Test 3
  int global_num = 1;
  
  void shared_function() {
          global_num++;
          cout << global_num << endl;
  }
  
  int global_var_test(){
          pid_t id = fork();
  
          if (id == 0){
                  shared_function();
                  id = fork();
  
                  if (id == 0) {
                          shared_function();
                  }
  
                  return EXIT_SUCCESS;
          }
  
          global_num += 2;
          cout << global_num << endl;
          return EXIT_SUCCESS;
  }
  
  
  
  // Test 4
  int recursive_fork_test(){
          for (int i=0; i<4; i++){
                  fork();
          }
  
          cout << ";)\n" << endl;
          return EXIT_SUCCESS;
  }
  
  // Test 5
  int multi_process_seq_test(){
          pid_t fork_ret = fork();
 
          if (fork_ret == 0){
                  fork_ret = fork();
 
                  if (fork_ret == 0){
                          cout << "Hi 3!" << endl;
                  } else {
                          cout << "Hi 2!" << endl;
                  }
          } else {
                  cout << "Hi 1!" << endl;
          }
 
          cout << "Bye" << endl;
 
          return EXIT_SUCCESS;
  }

  
  int main(){
  
          //pid_difference_test();
  
          //variable_exclusion_test();
  
          //global_var_test();
  
          //recursive_fork_test();

          multi_process_seq_test();
  }
  ```



<br> 

### Concept) Process State
- Temporary definition
  - Three states
    - Ready
    - Running
      - Can be interrupted through HW timer interrupt.
    - Terminated

### Concept) Context Switching
- Desc.)
  - Processes are managed by **kernel**
    - i.e.) a shared chunk of memory-resident OS code
    - The kernel is not a separate process, but rather runs as part of some existing process
  - Context switching can be described as below:   
    ![](../images/04/006.png)

### Concept) Scheduler
- Desc.)
  - One of the kernel codes that is called when switching between processes.
  - It runs when a process
    - starts
    - finishes
    - blocks (waiting on something)
    - has run for a certain amount of time (timer)
  - It is responsible for
    - choosing which process to run
      - Factors that are considered for its algorithm
        - Fairness 
        - Liveness
        - Throughput
        - Wait Time
        - etc.
    - deciding how long to run the process


<br><br>

[Back to Main](../main.md)