.OS
.CODE
.ADDR x8000

	JMP TRAP_GETC
	JMP TRAP_PUTC
	JMP TRAP_GETS
	JMP TRAP_PUTS
	JMP TRAP_TIMER
	JMP TRAP_GETC_TIMER
	JMP TRAP_DRAW_PIXEL
	JMP TRAP_RESET_VMEM
	JMP TRAP_BLT_VMEM
	JMP TRAP_DRAW_RECT

.FALIGN
	CONST R7, #0
	RTI
TRAP_GETC
	CONST R0, #0
	HICONST R0, #254
	LDR R0, R0, #0
	BRzp TRAP_GETC
	CONST R0, #2
	HICONST R0, #254
	LDR R0, R0, #0
	RTI
TRAP_PUTC
	CONST R1, #4
	HICONST R1, #254
	LDR R1, R1, #0
	BRzp TRAP_PUTC
	CONST R1, #6
	HICONST R1, #254
	STR R0, R1, #0
	RTI
TRAP_GETS
	CONST R1, #0
	HICONST R1, #0
	CONST R3, #0
	HICONST R3, #32
	CMP R0, R3
	BRn END_TRAP_GETS
	CONST R4, #255
	HICONST R4, #127
TRAP_GETS_WHILE
	CMPU R0, R4
	BRz TRAP_GETS_WRITE_NULL
	CMPU R0, R4
	BRp END_TRAP_GETS
TRAP_GETS_GETC_COPY
	CONST R2, #0
	HICONST R2, #254
	LDR R2, R2, #0
	BRzp TRAP_GETS_GETC_COPY
	CONST R2, #2
	HICONST R2, #254
	LDR R2, R2, #0
	CMPI R2, #10
	BRz TRAP_GETS_WRITE_NULL
	STR R2, R0, #0
	ADD R0, R0, #1
	ADD R1, R1, #1
	JMP TRAP_GETS_WHILE
TRAP_GETS_WRITE_NULL
	CONST R2, #0
	HICONST R2, #0
	STR R2, R0, #0
END_TRAP_GETS
	RTI
TRAP_PUTS
	CONST R1, #0
	HICONST R1, #32
	CMPU R0, R1
	BRn EXIT_TRAP_PUTS_WHILE
	CONST R1, #255
	HICONST R1, #127
	CMPU R0, R1
	BRp EXIT_TRAP_PUTS_WHILE
TRAP_PUTS_WHILE
	LDR R2, R0, #0
	BRz EXIT_TRAP_PUTS_WHILE
TRAP_PUTS_PUTC_COPY
	CONST R3, #4
	HICONST R3, #254
	LDR R3, R3, #0
	BRzp TRAP_PUTS_PUTC_COPY
	CONST R3, #6
	HICONST R3, #254
	STR R2, R3, #0
	ADD R0, R0, #1
	JMP TRAP_PUTS_WHILE
EXIT_TRAP_PUTS_WHILE
	RTI
TRAP_TIMER
	CONST R1, #10
	HICONST R1, #254
	STR R0, R1, #0
COUNT
	CONST R1, #8
	HICONST R1, #254
	LDR R1, R1, #0
	BRzp COUNT
	RTI
TRAP_GETC_TIMER
	CONST R1, #10
	HICONST R1, #254
	STR R0, R1, #0
	CONST R0, #0
TRAP_GETC_TIMER_LOOP
	CONST R1, #8
	HICONST R1, #254
	LDR R1, R1, #0
	BRn EXIT_BY_TIMEOUT
	CONST R1, #0
	HICONST R1, #254
	LDR R1, R1, #0
	BRzp TRAP_GETC_TIMER_LOOP
	CONST R0, #2
	HICONST R0, #254
	LDR R0, R0, #0
EXIT_BY_TIMEOUT
	RTI
TRAP_DRAW_PIXEL
	CONST R3, #0
	HICONST R3, #192
	CONST R4, #128
	CMPIU R1, #0
	BRn END_PIXEL
	CMPIU R1, #127
	BRp END_PIXEL
	CMPIU R0, #0
	BRn END_PIXEL
	CMPIU R0, #123
	BRp END_PIXEL
	MUL R4, R0, R4
	ADD R4, R4, R1
	ADD R4, R4, R3
	STR R2, R4, #0
END_PIXEL
	RTI
TRAP_RESET_VMEM
	CONST R4, #12
	HICONST R4, #254
	CONST R5, #1
	STR R5, R4, #0
	RTI
TRAP_BLT_VMEM
	CONST R4, #12
	HICONST R4, #254
	CONST R5, #2
	STR R5, R4, #0
	RTI
TRAP_DRAW_RECT
	CONST R6, #0
	HICONST R6, #176
	STR R0, R6, #0
	STR R1, R6, #1
	STR R2, R6, #2
	STR R3, R6, #3
	STR R4, R6, #4
	STR R7, R6, #5
	CONST R3, #0
	HICONST R3, #192
	CONST R4, #124
	CONST R5, #128
	LDR R1, R6, #2
	CMPI R1, #0
	BRnz EXIT_DRAW_SQUARE
	CMP R1, R5
	BRp EXIT_DRAW_SQUARE
	LDR R1, R6, #3
	CMPI R1, #0
	BRnz EXIT_DRAW_SQUARE
	CMP R1, R4
	BRp EXIT_DRAW_SQUARE
	LDR R0, R6, #0
	CMPI R0, #0
	BRn APPLY_TOP_LEFT_CORNER
	CMPIU R0, #127
	BRp APPLY_TOP_LEFT_CORNER
	LDR R0, R6, #1
	CMPI R0, #0
	BRn APPLY_TOP_LEFT_CORNER
	CMPIU R0, #123
	BRp APPLY_TOP_LEFT_CORNER
	JMP AFTER_TOP_LEFT_CORNER
APPLY_TOP_LEFT_CORNER
	CONST R0, #0
	STR R0, R6, #0
	STR R0, R6, #1
AFTER_TOP_LEFT_CORNER
	LDR R0, R6, #0
	LDR R1, R6, #1
	LDR R2, R6, #4
	MUL R7, R1, R5
	ADD R7, R7, R0
	ADD R7, R7, R3
	STR R7, R6, #6
	LDR R3, R6, #2
	LDR R4, R6, #3
DRAW_SQUARE_LOOP
	CMPI R4, #0
	BRnz EXIT_DRAW_SQUARE
	CONST R0, #124
	MUL R0, R0, R5
	CONST R1, #0
	HICONST R1, #192
	ADD R1, R1, R0
	CMP R7, R1
	BRnz CAL_HORIZONTAL_END
	SUB R7, R7, R0
	STR R7, R6, #6
CAL_HORIZONTAL_END
	ADD R0, R7, #0
	CONST R1, #0
	HICONST R1, #192
	SUB R0, R0, R1
	DIV R0, R0, R5
	ADD R0, R0, #1
	MUL R0, R0, R5
	ADD R0, R0, R1
DRAW_REC_VERT_LOOP
	CMPI R3, #0
	BRnz EXIT_DRAW_REC_VERT_LOOP
	CMP R7, R0
	BRn REGULAR_COLOR_PIXEL
	SUB R7, R7, R5
	STR R2, R7, #0
	ADD R7, R7, R5
	JMP AFTER_COLOR_PIXEL
REGULAR_COLOR_PIXEL
	STR R2, R7, #0
AFTER_COLOR_PIXEL
	ADD R7, R7, #1
	ADD R3, R3, #-1
	JMP DRAW_REC_VERT_LOOP
EXIT_DRAW_REC_VERT_LOOP
	LDR R3, R6, #2
	ADD R4, R4, #-1
	SUB R7, R7, R3
	ADD R7, R7, R5
	JMP DRAW_SQUARE_LOOP
EXIT_DRAW_SQUARE
	LDR R7, R6, #5
	RTI

.DATA
.ADDR xa000

OS_GLOBALS_MEM
	.BLKW x1000
LFSR

.ADDR xc000
OS_VIDEO_MEM
	.BLKW x3e00

